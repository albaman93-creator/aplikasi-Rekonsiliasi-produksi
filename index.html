<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan Produksi Terintegrasi</title>
	<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000080">
<link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            /* TEMA 1: WHITE BLUE (Default) */
            --bg-body: #ffffff;
            --text-main: #333;
            --table-border: #999;
            --header-bg: #000080; /* Biru Dongker */
            --header-text: white;
            --lot-header: #2E8B57; /* Hijau Laut untuk Header Lot */
            --input-bg: transparent;
            --input-focus: #f0f8ff;
            --btn-grad: linear-gradient(135deg, #000080, #4169e1);
            --anim-speed: 0s;
        }

        /* TEMA 2: HIJAU LAUT (Dark Mode) */
        body.theme-sea {
            --bg-body: #001f3f; /* Navy Dark */
            --text-main: #e0f7fa;
            --table-border: #546e7a;
            --header-bg: #20b2aa; /* Light Sea Green */
            --header-text: #001f3f; 
            --lot-header: #008080; /* Teal */
            --input-bg: rgba(255,255,255,0.05);
            --input-focus: rgba(32, 178, 170, 0.2);
            --btn-grad: linear-gradient(135deg, #20b2aa, #008080);
            --anim-speed: 3s;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background 0.5s, color 0.5s;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        h3 {
            color: var(--header-bg);
            border-bottom: 2px solid var(--header-bg);
            padding-bottom: 5px;
            margin-top: 30px;
            text-transform: uppercase;
            font-size: 16px;
        }

        /* --- STYLING TABEL --- */
        .table-wrapper {
            width: 100%;
            overflow-x: auto; /* Agar bisa digeser horizontal di HP */
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--table-border);
        }

        /* Kelas untuk membatasi lebar minimum tabel agar angka tidak gepeng */
        .wide-table { min-width: 900px; }
        .narrow-table { width: 100%; }

        th {
            background-color: var(--header-bg);
            color: var(--header-text);
            border: 1px solid white;
            padding: 6px 4px;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        /* Animasi Kilatan (Theme Sea) */
        body.theme-sea th::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-25deg);
            animation: shine var(--anim-speed) infinite linear;
        }
        @keyframes shine { 0% {left: -100%;} 50% {left: 200%;} 100% {left: 200%;} }

        .header-lot { background-color: var(--lot-header) !important; color: white !important; }
        
        td {
            border: 1px solid var(--table-border);
            padding: 0;
            height: 28px;
        }

        .label-cell { background-color: #e9ecef; color: #000; font-weight: bold; text-align: center; }
        .bg-grey { background-color: #f0f0f0; pointer-events: none; }
        
        /* Highlight Cells (Hijau Terang) */
        .highlight-green { background-color:  #ADFF2F !important; color: #000000 !important; font-weight: bold; }
        .highlight-lime { background-color: #ADFF2F !important; color: #000000 !important; font-weight: bold; }
        
        /* Dark mode overrides */
        body.theme-sea .label-cell { background-color: #263238; color: #fff; }
        body.theme-sea .bg-grey { background-color: #37474f; }

        /* --- INPUT STYLING --- */
        input {
            width: 100%; height: 100%;
            border: none;
            border-bottom: 1px solid #ccc;
            background: transparent;
            color: inherit;
            text-align: right;
            outline: none;
            font-size: 13px;
            padding: 0 5px;
            box-sizing: border-box;
            -moz-appearance: textfield; /* Remove spinner firefox */
        }
        input:focus { border-bottom: 2px solid var(--header-bg); background-color: var(--input-focus); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[readonly] { font-weight: bold; }
        
        /* Khusus input di cell highlight agar warnanya hitam pekat */
        .highlight-green input, .highlight-lime input { color: #000000; font-weight: bold; }

        /* --- TOMBOL --- */
        .btn-group { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        button {
            padding: 12px 25px; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold; color: white; font-size: 13px;
            background: var(--btn-grad);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        button:hover { opacity: 0.9; }

        /* --- LAYOUT LOTS (330px width cards) --- */
        .lots-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }
        
        .lot-wrapper {
            flex: 1 1 330px; /* Grow 1, Shrink 1, Basis 330px */
            min-width: 300px;
            max-width: 100%; /* Agar tidak overflow di HP */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

    </style>
	<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000080">
<link rel="apple-touch-icon" href="icon.png">
</head>
<body class="theme-white">

<div class="container">
    <div class="btn-group">
        <button onclick="setTheme('white')">Tema White Blue</button>
        <button onclick="setTheme('sea')">Tema Hijau Laut</button>
    </div>

    <h3>Tabel Rekonsiliasi Material</h3>
    <div class="table-wrapper">
        <table id="tblMaterial" class="wide-table">
            <colgroup>
                <col style="width: 14%"><col style="width: 10%">
                <col style="width: 8%"><col style="width: 8%"><col style="width: 8%"><col style="width: 8%"><col style="width: 8%">
                <col style="width: 10%"><col style="width: 10%">
            </colgroup>
            <thead>
                <tr>
                    <th rowspan="2">Nama Material</th><th rowspan="2">Keterangan Reject</th>
                    <th colspan="5">Reject per lot</th>
                    <th rowspan="2">Total Reject</th><th rowspan="2">Reject PR_BK_LL</th>
                </tr>
                <tr><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="9" class="label-cell">Material</td></tr>
                
                <tr>
                    <td rowspan="3" class="label-cell">FB FILM</td><td class="label-cell">Total</td>
                    <td class="highlight-green"><input type="text" id="m_film_tot_c1" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_film_tot_c2" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_film_tot_c3" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_film_tot_c4" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_film_tot_c5" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_film_tot_sum" readonly></td>
                    <td><input type="number" id="m_film_tot_pr" class="nav-input"></td>
                </tr>
                <tr>
                    <td class="label-cell">IPC + Fill</td>
                    <td class="bg-grey"><input type="text" id="m_film_ipc_c1" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_ipc_c2" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_ipc_c3" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_ipc_c4" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_ipc_c5" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_ipc_sum" readonly></td>
                    <td><input type="number" id="m_film_ipc_pr" class="nav-input"></td>
                </tr>
                <tr>
                    <td class="label-cell">Lainnya</td>
                    <td class="bg-grey"><input type="text" id="m_film_oth_c1" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_oth_c2" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_oth_c3" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_oth_c4" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_oth_c5" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_film_oth_sum" readonly></td>
                    <td><input type="number" id="m_film_oth_pr" class="nav-input"></td>
                </tr>

                <tr>
                    <td rowspan="3" class="label-cell">Port</td><td class="label-cell">Total</td>
                    <td class="highlight-green"><input type="text" id="m_port_tot_c1" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_port_tot_c2" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_port_tot_c3" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_port_tot_c4" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_port_tot_c5" readonly></td>
                    <td class="highlight-lime"><input type="text" id="m_port_tot_sum" readonly></td>
                    <td class="bg-grey"></td>
                </tr>
                <tr>
                    <td class="label-cell">IPC + Fill</td>
                    <td class="bg-grey"><input type="text" id="m_port_ipc_c1" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_port_ipc_c2" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_port_ipc_c3" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_port_ipc_c4" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_port_ipc_c5" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_port_ipc_sum" readonly></td>
                    <td class="bg-grey"></td>
                </tr>
                <tr>
                    <td class="label-cell">Lainnya</td>
                    <td><input type="number" id="m_port_oth_c1" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_port_oth_c2" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_port_oth_c3" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_port_oth_c4" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_port_oth_c5" class="nav-input trigger-recalc"></td>
                    <td class="bg-grey"></td><td class="bg-grey"></td>
                </tr>

                <tr>
                    <td rowspan="3" class="label-cell">CAP</td><td class="label-cell">Total</td>
                    <td class="highlight-green"><input type="text" id="m_cap_tot_c1" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_cap_tot_c2" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_cap_tot_c3" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_cap_tot_c4" readonly></td>
                    <td class="highlight-green"><input type="text" id="m_cap_tot_c5" readonly></td>
                    <td class="highlight-lime"><input type="text" id="m_cap_tot_sum" readonly></td>
                    <td><input type="number" id="m_cap_tot_pr" class="nav-input"></td>
                </tr>
                <tr>
                    <td class="label-cell">IPC</td>
                    <td class="bg-grey"><input type="text" id="m_cap_ipc_c1" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_cap_ipc_c2" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_cap_ipc_c3" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_cap_ipc_c4" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_cap_ipc_c5" readonly></td>
                    <td class="bg-grey"><input type="text" id="m_cap_ipc_sum" readonly></td>
                    <td><input type="number" id="m_cap_ipc_pr" class="nav-input"></td>
                </tr>
                <tr>
                    <td class="label-cell">Lainnya</td>
                    <td><input type="number" id="m_cap_oth_c1" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_cap_oth_c2" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_cap_oth_c3" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_cap_oth_c4" class="nav-input trigger-recalc"></td>
                    <td><input type="number" id="m_cap_oth_c5" class="nav-input trigger-recalc"></td>
                    <td class="bg-grey"><input type="text" id="m_cap_oth_sum" readonly></td><td class="bg-grey"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3>Input Produk</h3>
    <div class="table-wrapper">
        <table id="tblProduk" class="wide-table">
            <colgroup>
                <col style="width: 14%"><col style="width: 10%">
                <col style="width: 4%"><col style="width: 4%"><col style="width: 4%"><col style="width: 4%">
                <col style="width: 4%"><col style="width: 4%"><col style="width: 4%"><col style="width: 4%">
                <col style="width: 4%"><col style="width: 4%"><col style="width: 10%">
            </colgroup>
            <thead>
                <tr><th colspan="13" style="background-color: var(--header-bg); color:white;">PRODUK</th></tr>
                <tr>
                    <th rowspan="3">TUTOSOL</th><th rowspan="3">VTTS1</th>
                    <th colspan="2">A</th><th colspan="2">B</th><th colspan="2">C</th><th colspan="2">D</th><th colspan="2">E</th>
                    <th rowspan="2">Total Reject</th>
                </tr>
                <tr>
                    <th style="font-size:9px">Reject IPC</th><th style="font-size:9px">Reject Fill</th>
                    <th style="font-size:9px">Reject IPC</th><th style="font-size:9px">Reject Fill</th>
                    <th style="font-size:9px">Reject IPC</th><th style="font-size:9px">Reject Fill</th>
                    <th style="font-size:9px">Reject IPC</th><th style="font-size:9px">Reject Fill</th>
                    <th style="font-size:9px">Reject IPC</th><th style="font-size:9px">Reject Fill</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td></td><td></td>
                    <td><input type="number" id="prod_a_ipc" class="nav-input trigger-prod"></td><td><input type="number" id="prod_a_fill" class="nav-input trigger-prod"></td>
                    <td><input type="number" id="prod_b_ipc" class="nav-input trigger-prod"></td><td><input type="number" id="prod_b_fill" class="nav-input trigger-prod"></td>
                    <td><input type="number" id="prod_c_ipc" class="nav-input trigger-prod"></td><td><input type="number" id="prod_c_fill" class="nav-input trigger-prod"></td>
                    <td><input type="number" id="prod_d_ipc" class="nav-input trigger-prod"></td><td><input type="number" id="prod_d_fill" class="nav-input trigger-prod"></td>
                    <td><input type="number" id="prod_e_ipc" class="nav-input trigger-prod"></td><td><input type="number" id="prod_e_fill" class="nav-input trigger-prod"></td>
                    <td class="bg-grey"><input type="text" id="prod_total" readonly></td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3>Rekonsiliasi Material Kemasan Primer</h3>
    <div class="table-wrapper">
        <table id="tblKemasan" class="wide-table">
            <colgroup>
                <col style="width: 15%"><col style="width: 8%">
                <col style="width: 5%"><col style="width: 5%"><col style="width: 5%">
                <col style="width: 5%"><col style="width: 5%"><col style="width: 5%">
                <col style="width: 7%"><col style="width: 8%"><col style="width: 8%"><col style="width: 8%">
            </colgroup>
            <thead>
                <tr>
                    <th rowspan="2">Nama Material</th><th rowspan="2">Pemakaian Standar (A)</th>
                    <th colspan="3">Terpakai (B)</th><th colspan="3">Reject / Afkir (C)</th>
                    <th rowspan="2">FKM (F)</th><th rowspan="2">Sisa Teoritis (D)</th><th rowspan="2">Sisa Aktual (E)</th><th rowspan="2">Selisih</th>
                </tr>
                <tr><th colspan="3"></th><th colspan="3"></th></tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label-cell">FB Film</td>
                    <td><input type="number" id="k_film_a" class="nav-input trigger-kem"></td>
                    <td class="bg-grey"><input type="text" id="k_film_b1" readonly></td><td class="bg-grey"><input type="text" id="k_film_b2" readonly></td><td class="bg-grey"><input type="text" id="k_film_b3" readonly></td>
                    <td class="bg-grey"><input type="text" id="k_film_c1" readonly></td><td class="bg-grey"><input type="text" id="k_film_c2" readonly></td><td class="bg-grey"><input type="text" id="k_film_c3" readonly></td>
                    <td><input type="number" id="k_film_f" class="nav-input trigger-kem"></td><td class="bg-grey"><input type="text" id="k_film_d" readonly></td><td><input type="number" id="k_film_e" class="nav-input trigger-kem"></td><td class="bg-grey"><input type="text" id="k_film_diff" readonly></td>
                </tr>
                <tr>
                    <td class="label-cell">PORT</td>
                    <td><input type="number" id="k_port_a" class="nav-input trigger-kem"></td>
                    <td><input type="number" id="k_port_b1" class="nav-input trigger-kem"></td><td><input type="number" id="k_port_b2" class="nav-input trigger-kem"></td><td><input type="number" id="k_port_b3" class="nav-input trigger-kem"></td>
                    <td><input type="number" id="k_port_c1" class="nav-input trigger-kem"></td><td><input type="number" id="k_port_c2" class="nav-input trigger-kem"></td><td><input type="number" id="k_port_c3" class="nav-input trigger-kem"></td>
                    <td><input type="number" id="k_port_f" class="nav-input trigger-kem"></td><td class="bg-grey"><input type="text" id="k_port_d" readonly></td><td><input type="number" id="k_port_e" class="nav-input trigger-kem"></td><td class="bg-grey"><input type="text" id="k_port_diff" readonly></td>
                </tr>
                <tr>
                    <td class="label-cell">CAP</td>
                    <td><input type="number" id="k_cap_a" class="nav-input trigger-kem"></td>
                    <td><input type="number" id="k_cap_b1" class="nav-input trigger-kem"></td><td><input type="number" id="k_cap_b2" class="nav-input trigger-kem"></td><td><input type="number" id="k_cap_b3" class="nav-input trigger-kem"></td>
                    <td><input type="number" id="k_cap_c1" class="nav-input trigger-kem"></td><td><input type="number" id="k_cap_c2" class="nav-input trigger-kem"></td><td><input type="number" id="k_cap_c3" class="nav-input trigger-kem"></td>
                    <td><input type="number" id="k_cap_f" class="nav-input trigger-kem"></td><td class="bg-grey"><input type="text" id="k_cap_d" readonly></td><td><input type="number" id="k_cap_e" class="nav-input trigger-kem"></td><td class="bg-grey"><input type="text" id="k_cap_diff" readonly></td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3>Detail Per Lot & Rangkuman</h3>
    
    <div class="lots-container">
        
        <div class="lot-wrapper">
            <table id="tblRangkuman" class="narrow-table">
                <colgroup><col style="width: 50%"><col style="width: 50%"></colgroup>
                <thead><tr><th colspan="2" style="background-color: var(--header-bg); color:white;">Rangkuman Semua Produk</th></tr></thead>
                <tbody>
                    <tr><td>Total FG</td><td class="bg-grey"><input type="text" id="sum_fg" readonly></td></tr>
                    <tr><td>SPESIMEN</td><td class="bg-grey"><input type="text" id="sum_specimen" readonly></td></tr>
                    <tr><td>SAMPEL</td><td class="bg-grey"><input type="text" id="sum_sample" readonly></td></tr>
                    <tr><td>RETAIN FB</td><td class="bg-grey"><input type="text" id="sum_retain" readonly></td></tr>
                    <tr><td>INTEGRITY SEAL</td><td class="bg-grey"><input type="text" id="sum_integrity" readonly></td></tr>
                    <tr><td>IPC BAG PRESS</td><td class="bg-grey"><input type="text" id="sum_ipc" readonly></td></tr>
                    <tr><td>REJECT</td><td class="bg-grey"><input type="text" id="sum_reject" readonly></td></tr>
                    <tr><td class="label-cell">TOTAL SELURUH</td><td class="bg-grey"><input type="text" id="sum_all_total" readonly></td></tr>
                    <tr><td class="label-cell">ESTIMASI PRODUK</td><td><input type="number" id="sum_estimation" class="nav-input trigger-summary"></td></tr>
                    <tr><td class="label-cell">PERBEDAAN</td><td class="bg-grey"><input type="text" id="sum_diff" readonly></td></tr>
                </tbody>
            </table>
        </div>

        <div id="lotsInjectPoint" style="display:contents;"></div>

        <div class="lot-wrapper">
            <table id="lot_e" class="narrow-table">
                <colgroup><col style="width: 50%"><col style="width: 50%"></colgroup>
                <thead><tr><th colspan="2" class="header-lot">LOT E</th></tr></thead>
                <tbody>
                    <tr><td>Carload 1</td><td><input type="number" id="lot_e_car1" class="nav-input trigger-lot"></td></tr>
                    <tr><td>Carload 2 (Hitung)</td><td class="bg-grey"><input type="text" id="lot_e_car2" readonly></td></tr>
                    <tr><td>Jumlah Bag/Layer</td><td><input type="number" id="lot_e_baglayer" class="nav-input trigger-lot"></td></tr>
                    <tr><td>Total Layer</td><td><input type="number" id="lot_e_layer" class="nav-input trigger-lot"></td></tr>
                    <tr><td>Bag Recehan</td><td><input type="number" id="lot_e_recehan" class="nav-input trigger-lot"></td></tr>
                    <tr><td>Total FG</td><td class="bg-grey"><input type="text" id="lot_e_fg" readonly></td></tr>
                    <tr><td>SPESIMEN</td><td><input type="number" id="lot_e_specimen" class="nav-input trigger-lot"></td></tr>
                    <tr><td>INTEGRITY SEAL</td><td><input type="number" id="lot_e_integrity" class="nav-input trigger-lot"></td></tr>
                    <tr><td>Retain FB</td><td><input type="number" id="lot_e_retain" class="nav-input trigger-lot"></td></tr>
                    <tr><td>IPC Bag Press</td><td><input type="number" id="lot_e_ipc" class="nav-input trigger-lot"></td></tr>
                    <tr><td>Sampel</td><td><input type="number" id="lot_e_sample" class="nav-input trigger-lot"></td></tr>
                    <tr><td>Reject</td><td><input type="number" id="lot_e_reject" class="nav-input trigger-lot"></td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <div class="btn-group">
        <button class="btn-save" onclick="saveData()">Simpan Data</button>
        <button class="btn-load" onclick="loadData()">Muat Data</button>
        <button class="btn-reset" onclick="resetData()">Reset Semua</button>
    </div>
</div>

<script>
    // --- PENDAFTARAN SERVICE WORKER (YANG BENAR) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registered!'))
                .catch(err => console.log('Service Worker registration failed: ', err));
        });
    }

    // --- 0. GENERATE LOT A-D ---
    const lots = ['a', 'b', 'c', 'd'];
    const injectPoint = document.getElementById('lotsInjectPoint');
    
    // Cek agar tidak error jika elemen belum dimuat
    if (injectPoint) {
        lots.forEach(lot => {
            const wrapper = document.createElement('div');
            wrapper.className = 'lot-wrapper';
            wrapper.innerHTML = `
                <table id="lot_${lot}" class="narrow-table">
                    <colgroup><col style="width: 50%"><col style="width: 50%"></colgroup>
                    <thead><tr><th colspan="2" class="header-lot">LOT ${lot.toUpperCase()}</th></tr></thead>
                    <tbody>
                        <tr><td>Carload 1</td><td><input type="number" id="lot_${lot}_car1" class="nav-input trigger-lot"></td></tr>
                        <tr><td>Carload 2</td><td><input type="number" id="lot_${lot}_car2" class="nav-input trigger-lot"></td></tr>
                        <tr><td>Total FG</td><td class="bg-grey"><input type="text" id="lot_${lot}_fg" readonly></td></tr>
                        <tr><td>SPESIMEN</td><td><input type="number" id="lot_${lot}_specimen" class="nav-input trigger-lot"></td></tr>
                        <tr><td>INTEGRITY SEAL</td><td><input type="number" id="lot_${lot}_integrity" class="nav-input trigger-lot"></td></tr>
                        <tr><td>Retain FB</td><td><input type="number" id="lot_${lot}_retain" class="nav-input trigger-lot"></td></tr>
                        <tr><td>IPC Bag Press</td><td><input type="number" id="lot_${lot}_ipc" class="nav-input trigger-lot"></td></tr>
                        <tr><td>Sampel</td><td><input type="number" id="lot_${lot}_sample" class="nav-input trigger-lot"></td></tr>
                        <tr><td>Reject</td><td><input type="number" id="lot_${lot}_reject" class="nav-input trigger-lot"></td></tr>
                    </tbody>
                </table>`;
            injectPoint.appendChild(wrapper);
        });
    }

    // --- 1. UTILITIES ---
    function getVal(id) { const el = document.getElementById(id); return el && el.value ? parseFloat(el.value) : 0; }
    function setVal(id, val, dec = 0) {
        const el = document.getElementById(id);
        if(!el) return;
        el.value = (val === 0 && document.activeElement !== el) ? "" : (dec > 0 ? val.toFixed(dec) : val);
    }

    // --- 2. LOGIC: PRODUK -> MATERIAL ---
    function calcProdToMat() {
        const map = [
            { id:'1', i:'prod_a_ipc', f:'prod_a_fill' },
            { id:'2', i:'prod_b_ipc', f:'prod_b_fill' },
            { id:'3', i:'prod_c_ipc', f:'prod_c_fill' },
            { id:'4', i:'prod_d_ipc', f:'prod_d_fill' },
            { id:'5', i:'prod_e_ipc', f:'prod_e_fill' }
        ];
        let total = 0;
        map.forEach(m => {
            let sum = getVal(m.i) + getVal(m.f);
            setVal(`m_port_ipc_c${m.id}`, sum);
            setVal(`m_cap_ipc_c${m.id}`, sum);
            total += sum;
        });
        setVal('prod_total', total);
        calcMatInternal();
    }

    // --- 3. LOGIC: MATERIAL INTERNAL ---
    function calcMatInternal() {
        const cols = ['1','2','3','4','5'];
        let tFilm=0, tPort=0, tCap11=0, tCap12=0;

        cols.forEach(c => {
            // Port
            let pIPC = getVal(`m_port_ipc_c${c}`); // From Product
            let pOth = getVal(`m_port_oth_c${c}`); // Manual
            setVal(`m_port_tot_c${c}`, pIPC + pOth);
            tPort += pIPC;

            // FB Film (Calc from Port)
            let fIPC = pIPC * 0.142;
            let fOth = pOth * 0.142;
            let fTot = fIPC + fOth;
            setVal(`m_film_ipc_c${c}`, fIPC, 3);
            setVal(`m_film_oth_c${c}`, fOth, 3);
            setVal(`m_film_tot_c${c}`, fTot, 3);
            tFilm += fTot;

            // Cap
            let cIPC = getVal(`m_cap_ipc_c${c}`); // From Product
            let cOth = getVal(`m_cap_oth_c${c}`); // Manual
            setVal(`m_cap_tot_c${c}`, cIPC + cOth);
            tCap11 += cIPC;
            tCap12 += cOth;
        });

        setVal('m_film_tot_sum', tFilm, 3);
        setVal('m_port_tot_sum', tPort); 
        setVal('m_cap_tot_sum', tCap11 + tCap12);
    }

    // --- 4. LOGIC: KEMASAN PRIMER ---
    function calcKemasan() {
        ['b1','b2','b3','c1','c2','c3'].forEach(s => {
            setVal(`k_film_${s}`, getVal(`k_port_${s}`) * 0.142, 3);
        });

        ['film','port','cap'].forEach(row => {
            let A = getVal(`k_${row}_a`);
            let F = getVal(`k_${row}_f`);
            let B = 0, C = 0;
            if(row === 'film') {
                B = parseFloat(document.getElementById('k_film_b1').value||0) + parseFloat(document.getElementById('k_film_b2').value||0) + parseFloat(document.getElementById('k_film_b3').value||0);
                C = parseFloat(document.getElementById('k_film_c1').value||0) + parseFloat(document.getElementById('k_film_c2').value||0) + parseFloat(document.getElementById('k_film_c3').value||0);
            } else {
                B = getVal(`k_${row}_b1`) + getVal(`k_${row}_b2`) + getVal(`k_${row}_b3`);
                C = getVal(`k_${row}_c1`) + getVal(`k_${row}_c2`) + getVal(`k_${row}_c3`);
            }
            let D = (A+F)-(B+C);
            let E = getVal(`k_${row}_e`);
            setVal(`k_${row}_d`, D, row==='film'?3:0);
            setVal(`k_${row}_diff`, D-E, row==='film'?3:0);
        });
    }

    // --- 5. LOGIC: LOT & SUMMARY ---
    function calcLots() {
        // Lot A-D Logic
        ['a','b','c','d'].forEach(l => {
            setVal(`lot_${l}_fg`, getVal(`lot_${l}_car1`) + getVal(`lot_${l}_car2`));
        });

        // Lot E Logic
        let car2E = (getVal('lot_e_baglayer') * getVal('lot_e_layer')) + getVal('lot_e_recehan');
        setVal('lot_e_car2', car2E);
        setVal('lot_e_fg', getVal('lot_e_car1') + car2E);

        // Summary Aggregation
        const fields = ['fg','specimen','sample','retain','integrity','ipc','reject'];
        let grandTotal = 0;
        fields.forEach(f => {
            let sum = 0;
            ['a','b','c','d','e'].forEach(l => sum += getVal(`lot_${l}_${f}`));
            setVal(`sum_${f}`, sum);
            grandTotal += sum;
        });

        setVal('sum_all_total', grandTotal);
        setVal('sum_diff', getVal('sum_estimation') - grandTotal);
    }

    // --- EVENT LISTENERS ---
    document.body.addEventListener('input', (e) => {
        if(e.target.classList.contains('trigger-prod')) calcProdToMat();
        if(e.target.classList.contains('trigger-recalc')) calcMatInternal();
        if(e.target.classList.contains('trigger-kem')) calcKemasan();
        if(e.target.classList.contains('trigger-lot') || e.target.classList.contains('trigger-summary')) calcLots();
    });

    // --- SMART BACKSPACE NAVIGATION ---
    const allInputs = document.getElementsByTagName('input');
    Array.from(allInputs).forEach((input, i) => {
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Backspace' && input.value === '' && i > 0) {
                e.preventDefault();
                allInputs[i-1].focus();
            }
        });
    });

    // --- THEME ---
    function setTheme(theme) {
        document.body.className = `theme-${theme}`;
    }

    // --- STORAGE ---
    function saveData() {
        const data = {};
        document.querySelectorAll('input').forEach(el => { if(el.id) data[el.id] = el.value; });
        localStorage.setItem('rekon_db_vFinal', JSON.stringify(data));
        alert('Data Tersimpan');
    }
    
    function loadData() {
        try {
            const data = JSON.parse(localStorage.getItem('rekon_db_vFinal'));
            if(data) {
                for(let k in data) { if(document.getElementById(k)) document.getElementById(k).value = data[k]; }
                calcProdToMat(); calcMatInternal(); calcKemasan(); calcLots();
                alert('Data Dimuat');
            } else {
                alert('Tidak ada data tersimpan');
            }
        } catch (e) {
            console.error("Error loading data", e);
            alert("Data korup atau error.");
        }
    }

    function resetData() {
        if(confirm('Hapus semua data?')) {
            document.querySelectorAll('input').forEach(el => el.value = "");
            calcProdToMat(); calcMatInternal(); calcKemasan(); calcLots();
        }
    }
</script>
</body>
</html>